# ==========================================
# KOBE Corporation - Site Principal
# ==========================================

upstream kobe_web_backend {
    server kobecorporation-web:80;
    keepalive 32;
}

# ==========================================
# Configuration HTTP (temporaire, avant obtention des certificats)
# ==========================================
server {
    listen 80;
    server_name kobecorporation.com www.kobecorporation.com;

    # Logs
    access_log /var/log/nginx/kobecorp_access.log main;
    error_log /var/log/nginx/kobecorp_error.log warn;

    # Certbot challenge (IMPORTANT : doit être accessible)
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
        default_type text/plain;
        try_files $uri =404;
    }

    # Redirection non-www → www (HTTP uniquement pour l'instant)
    if ($host = 'kobecorporation.com') {
        return 301 http://www.kobecorporation.com$request_uri;
    }

    # Compression gzip pour améliorer les performances
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json application/font-woff application/font-woff2 font/woff font/woff2 image/svg+xml;
    
    # Compression Brotli (meilleure compression que gzip)
    # Note: nécessite le module nginx-module-brotli installé
    # Décommentez si Brotli est disponible
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css text/xml text/javascript application/javascript application/json application/font-woff application/font-woff2 font/woff font/woff2 image/svg+xml;

    # Servir le frontend en HTTP (temporairement, pas de redirection HTTPS)
    location / {
        proxy_pass http://kobe_web_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket pour Hot Module Replacement (dev)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Sitemap et robots.txt - Accessibles publiquement avec le bon Content-Type
    location = /sitemap.xml {
        proxy_pass http://kobe_web_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        add_header Content-Type "application/xml; charset=utf-8" always;
        add_header Cache-Control "public, max-age=3600";
        access_log on;
    }

    location = /robots.txt {
        proxy_pass http://kobe_web_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        add_header Content-Type "text/plain; charset=utf-8" always;
        add_header Cache-Control "public, max-age=3600";
        access_log on;
    }

    # Cache des assets statiques
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        proxy_pass http://kobe_web_backend;

        # Cache agressif pour les assets
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Healthcheck endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Bloquer l'accès aux fichiers cachés
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ==========================================
# Configuration HTTPS (À DÉCOMMENTER APRÈS OBTENTION DES CERTIFICATS)
# ==========================================
# 
# # Redirection HTTP → HTTPS (à activer après SSL)
# server {
#     listen 80;
#     server_name kobecorporation.com www.kobecorporation.com;
#     
#     # Certbot challenge
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }
#     
#     return 301 https://www.kobecorporation.com$request_uri;
# }
#
# # Redirection non-www → www (HTTPS)
# server {
#     listen 443 ssl;
#     http2 on;
#     server_name kobecorporation.com;
#
#     ssl_certificate /etc/letsencrypt/live/kobecorporation.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/kobecorporation.com/privkey.pem;
#
#     return 301 https://www.kobecorporation.com$request_uri;
# }
#
# # Configuration HTTPS principale
# server {
#     listen 443 ssl;
#     http2 on;
#     server_name www.kobecorporation.com;
#
#     # Certificats SSL
#     ssl_certificate /etc/letsencrypt/live/www.kobecorporation.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/www.kobecorporation.com/privkey.pem;
#
#     # Protocoles et ciphers SSL
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
#     ssl_prefer_server_ciphers off;
#
#     # HSTS
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
#
#     # Logs
#     access_log /var/log/nginx/kobecorp_access.log main;
#     error_log /var/log/nginx/kobecorp_error.log warn;
#
#     # Proxy vers React
#     location / {
#         proxy_pass http://kobe_web_backend;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Host $host;
#         proxy_set_header X-Forwarded-Port $server_port;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#         proxy_buffering off;
#         proxy_request_buffering off;
#     }
#
#     # Sitemap et robots.txt - Accessibles publiquement avec le bon Content-Type
#     location = /sitemap.xml {
#         proxy_pass http://kobe_web_backend;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         add_header Content-Type "application/xml; charset=utf-8" always;
#         add_header Cache-Control "public, max-age=3600";
#         access_log on;
#     }
#
#     location = /robots.txt {
#         proxy_pass http://kobe_web_backend;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         add_header Content-Type "text/plain; charset=utf-8" always;
#         add_header Cache-Control "public, max-age=3600";
#         access_log on;
#     }
#
#     # Cache des assets statiques
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
#         proxy_pass http://kobe_web_backend;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#     }
#
#     # Healthcheck endpoint
#     location /health {
#         access_log off;
#         return 200 "healthy\n";
#         add_header Content-Type text/plain;
#     }
#
#     # Bloquer l'accès aux fichiers cachés
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }
# }
